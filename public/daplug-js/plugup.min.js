/*
************************************************************************
Copyright (c) 2012 UBINITY SAS

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*************************************************************************
*/
var Class=function(){var b={};return{extend:function(e,f){1==arguments.length&&(f=e,e=null);var m=function(){arguments[0]!=b&&this.initialize.apply(this,arguments)};"function"==typeof e&&(m.prototype=new e(b));var k=[];f&&f.include&&(f.include.reverse?k=k.concat(f.include.reverse()):k.push(f.include),delete f.include);f&&Class.inherit(m.prototype,f);for(var n=0;mixin=k[n];n++)Class.mixin(m.prototype,mixin);return m},mixin:function(b,f,m){m=m||!1;if("undefined"!=typeof f&&null!==f)for(var k in f)if(m|| !b[k]&&"function"==typeof f[k])b[k]=f[k];return b},inherit:function(b,f,m){if(3==arguments.length){var k=b[m],n=f[m],l=n,n=function(){var b=this.parent;this.parent=k;var e=l.apply(this,arguments);b?this.parent=b:delete this.parent;return e};n.valueOf=function(){return l};n.toString=function(){return l.toString()};b[m]=n}else for(n in f)b[n]&&"function"==typeof f[n]?Class.inherit(b,f,n):b[n]=f[n];return b},singleton:function(){var e=arguments;if(2==e.length&&e[0].getInstance){var f=e[0].getInstance(b); f&&(e[0]=f)}return function(e){var f=!1,n=Class.extend.apply(e.callee,e);return{getInstance:function(e){return e==b?n:f?f:f=new n}}}(e)}}}();Class.create=function(){return Class.extend.apply(this,arguments)}; !function a(e,f,m){function k(d,l){if(!f[d]){if(!e[d]){var r="function"==typeof require&&require;if(!l&&r)return r(d,!0);if(n)return n(d,!0);throw Error("Cannot find module '"+d+"'");}r=f[d]={exports:{}};e[d][0].call(r.exports,function(f){var m=e[d][1][f];return k(m?m:f)},r,r.exports,a,e,f,m)}return f[d].exports}for(var n="function"==typeof require&&require,l=0;l<m.length;l++)k(m[l]);return k}({1:[function(b){window.Q=b("./q")},{"./q":2}],2:[function(b,e){function f(c){return function(){return V.apply(c, arguments)}}function m(c,h){if(z&&h.stack&&"object"==typeof c&&null!==c&&c.stack&&-1===c.stack.indexOf(J)){for(var b=[],d=h;d;d=d.source)d.stack&&b.unshift(d.stack);b.unshift(c.stack);for(var b=b.join("\n"+J+"\n").split("\n"),d=[],e=0;e<b.length;++e){var f=b[e],g;if(g=k(f)){var m=g[1];g=g[0]===L&&m>=W&&X>=m}else g=!1;g||(g=f,-1!==g.indexOf("(module.js:")||-1!==g.indexOf("(node.js:")||!f||d.push(f))}b=d.join("\n");c.stack=b}}function k(c){var h=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(c);return h||(h= /at ([^ ]+):(\d+):(?:\d+)$/.exec(c))?[h[1],Number(h[2])]:(c=/.*@(.+):(\d+)$/.exec(c))?[c[1],Number(c[2])]:void 0}function n(){if(z)try{throw Error();}catch(c){var h=c.stack.split("\n"),h=0<h[0].indexOf("@")?h[1]:h[2];if(h=k(h))return L=h[0],h[1]}}function l(c,h,b){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(h+" is deprecated, use "+b+" instead.",Error("").stack),c.apply(c,arguments)}}function d(c){return v(c)?c:M(c)?Y(c):C(c)}function p(){function c(c){h= c;k.source=c;A(b,function(h,b){s(function(){c.promiseDispatch.apply(c,b)})},void 0);e=b=void 0}var h,b=[],e=[],f=D(p.prototype),k=D(g.prototype);if(k.promiseDispatch=function(c,d,f){var g=q(arguments);b?(b.push(g),"when"===d&&f[1]&&e.push(f[1])):s(function(){h.promiseDispatch.apply(h,g)})},k.valueOf=l(function(){if(b)return k;var c=N(h);return v(c)&&(h=c),c},"valueOf","inspect"),k.inspect=function(){return h?h.inspect():{state:"pending"}},d.longStackSupport&&z)try{throw Error();}catch(m){k.stack= m.stack.substring(m.stack.indexOf("\n")+1)}return f.promise=k,f.resolve=function(b){h||c(d(b))},f.fulfill=function(b){h||c(C(b))},f.reject=function(b){h||c(u(b))},f.notify=function(c){h||A(e,function(h,b){s(function(){b(c)})},void 0)},f}function r(c){if("function"!=typeof c)throw new TypeError("resolver must be a function.");var h=p();try{c(h.resolve,h.reject,h.notify)}catch(b){h.reject(b)}return h.promise}function g(c,h,b){void 0===h&&(h=function(c){return u(Error("Promise does not support operation: "+ c))});void 0===b&&(b=function(){return{state:"unknown"}});var d=D(g.prototype);if(d.promiseDispatch=function(b,e,K){var f;try{f=c[e]?c[e].apply(d,K):h.call(d,e,K)}catch(g){f=u(g)}b&&b(f)},d.inspect=b,b){var e=b();"rejected"===e.state&&(d.exception=e.reason);d.valueOf=l(function(){var c=b();return"pending"===c.state||"rejected"===c.state?d:c.value})}return d}function t(c,h,b,e){return d(c).then(h,b,e)}function N(c){if(v(c)){var h=c.inspect();if("fulfilled"===h.state)return h.value}return c}function v(c){return c=== Object(c)&&"function"==typeof c.promiseDispatch&&"function"==typeof c.inspect}function M(c){return c===Object(c)&&"function"==typeof c.then}function O(){for(var c=0;c<w.length;c++){var h=w[c];h&&"undefined"!=typeof h.stack?console.warn("Unhandled rejection reason:",h.stack):console.warn("Unhandled rejection reason (no stack):",h)}}function E(){w.length=0;B.length=0;F=!1;x||(x=!0,"undefined"!=typeof process&&process.on&&process.on("exit",O))}function Z(c,h){x&&(B.push(c),w.push(h),F||"undefined"== typeof window||window.Touch||!window.console||console.warn("[Q] Unhandled rejection reasons (should be empty):",w),F=!0)}function u(c){var h=g({when:function(h){if(h&&x){var b=$(B,this);-1!==b&&(B.splice(b,1),w.splice(b,1))}return h?h(c):this}},function(){return this},function(){return{state:"rejected",reason:c}});return Z(h,c),h}function C(c){return g({when:function(){return c},get:function(h){return c[h]},set:function(h,b){c[h]=b},"delete":function(h){delete c[h]},post:function(h,b){return null=== h||void 0===h?c.apply(void 0,b):c[h].apply(c,b)},apply:function(h,b){return c.apply(h,b)},keys:function(){return aa(c)}},void 0,function(){return{state:"fulfilled",value:c}})}function Y(c){var h=p();return s(function(){try{c.then(h.resolve,h.reject,h.notify)}catch(b){h.reject(b)}}),h.promise}function P(c,h,b){return d(c).spread(h,b)}function R(c,h,b){return d(c).dispatch(h,b)}function y(c){return t(c,function(c){var b=0,d=p();return A(c,function(e,f,g){var k;v(f)&&"fulfilled"===(k=f.inspect()).state? c[g]=k.value:(++b,t(f,function(e){c[g]=e;0===--b&&d.resolve(c)},d.reject,function(c){d.notify({index:g,value:c})}))},void 0),0===b&&d.resolve(c),d.promise})}function S(c){return t(c,function(c){return c=G(c,d),t(y(G(c,function(c){return t(c,T,T)})),function(){return c})})}function U(c){return t(c,function(c){return y(G(c,function(b,d){return t(b,function(b){return c[d]={state:"fulfilled",value:b},c[d]},function(b){return c[d]={state:"rejected",reason:b},c[d]})})).thenResolve(c)})}var z=!1;try{throw Error(); }catch(ba){z=!!ba.stack}var L,H,W=n(),T=function(){},s=function(){function c(){for(;h.next;){h=h.next;var b=h.task;h.task=void 0;var e=h.domain;e&&(h.domain=void 0,e.enter());try{b()}catch(g){if(f)throw e&&e.exit(),setTimeout(c,0),e&&e.enter(),g;setTimeout(function(){throw g;},0)}e&&e.exit()}d=!1}var h={task:void 0,next:null},b=h,d=!1,e=void 0,f=!1;if(s=function(c){b=b.next={task:c,domain:f&&process.domain,next:null};d||(d=!0,e())},"undefined"!=typeof process&&process.nextTick)f=!0,e=function(){process.nextTick(c)}; else if("function"==typeof setImmediate)e="undefined"!=typeof window?setImmediate.bind(window,c):function(){setImmediate(c)};else if("undefined"!=typeof MessageChannel){var g=new MessageChannel;g.port1.onmessage=c;e=function(){g.port2.postMessage(0)}}else e=function(){setTimeout(c,0)};return s}(),V=Function.call,q=f(Array.prototype.slice),A=f(Array.prototype.reduce||function(c,b){var d=0,e=this.length;if(1===arguments.length)for(;;){if(d in this){b=this[d++];break}if(++d>=e)throw new TypeError;}for(;e> d;d++)d in this&&(b=c(b,this[d],d));return b}),$=f(Array.prototype.indexOf||function(c){for(var b=0;b<this.length;b++)if(this[b]===c)return b;return-1}),G=f(Array.prototype.map||function(c,b){var d=this,e=[];return A(d,function(f,g,k){e.push(c.call(b,g,k,d))},void 0),e}),D=Object.create||function(c){function b(){}return b.prototype=c,new b},ca=f(Object.prototype.hasOwnProperty),aa=Object.keys||function(c){var b=[],d;for(d in c)ca(c,d)&&b.push(d);return b},da=f(Object.prototype.toString);H="undefined"!= typeof ReturnValue?ReturnValue:function(c){this.value=c};var I;try{new Function("(function* (){ yield 1; })"),I=!0}catch(ea){I=!1}var J="From previous event:";d.resolve=d;d.nextTick=s;d.longStackSupport=!1;d.defer=p;p.prototype.makeNodeResolver=function(){var c=this;return function(b,d){b?c.reject(b):2<arguments.length?c.resolve(q(arguments,1)):c.resolve(d)}};d.promise=r;d.passByCopy=function(c){return c};g.prototype.passByCopy=function(){return this};d.join=function(c,b){return d(c).join(b)};g.prototype.join= function(c){return d([this,c]).spread(function(c,b){if(c===b)return c;throw Error("Can't join: not the same: "+c+" "+b);})};d.race=function(c){return r(function(b,e){for(var f=0,g=c.length;g>f;f++)d(c[f]).then(b,e)})};g.prototype.race=function(){return this.then(d.race)};d.makePromise=g;g.prototype.toString=function(){return"[object Promise]"};g.prototype.then=function(c,b,e){function f(b){try{return"function"==typeof c?c(b):b}catch(d){return u(d)}}function g(c){if("function"==typeof b){m(c,k);try{return b(c)}catch(d){return u(d)}}return u(c)} var k=this,l=p(),n=!1;return s(function(){k.promiseDispatch(function(c){n||(n=!0,l.resolve(f(c)))},"when",[function(c){n||(n=!0,l.resolve(g(c)))}])}),k.promiseDispatch(void 0,"when",[void 0,function(c){var b,h=!1;try{b="function"==typeof e?e(c):c}catch(f){if(h=!0,!d.onerror)throw f;d.onerror(f)}h||l.notify(b)}]),l.promise};d.when=t;g.prototype.thenResolve=function(c){return this.then(function(){return c})};d.thenResolve=function(c,b){return d(c).thenResolve(b)};g.prototype.thenReject=function(c){return this.then(function(){throw c; })};d.thenReject=function(c,b){return d(c).thenReject(b)};d.nearer=N;d.isPromise=v;d.isPromiseAlike=M;d.isPending=function(c){return v(c)&&"pending"===c.inspect().state};g.prototype.isPending=function(){return"pending"===this.inspect().state};d.isFulfilled=function(c){return!v(c)||"fulfilled"===c.inspect().state};g.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state};d.isRejected=function(c){return v(c)&&"rejected"===c.inspect().state};g.prototype.isRejected=function(){return"rejected"=== this.inspect().state};var w=[],B=[],F=!1,x=!0;d.resetUnhandledRejections=E;d.getUnhandledReasons=function(){return w.slice()};d.stopUnhandledRejectionTracking=function(){E();"undefined"!=typeof process&&process.on&&process.removeListener("exit",O);x=!1};E();d.reject=u;d.fulfill=C;d.master=function(c){return g({isDef:function(){}},function(b,d){return R(c,b,d)},function(){return d(c).inspect()})};d.spread=P;g.prototype.spread=function(c,b){return this.all().then(function(b){return c.apply(void 0,b)}, b)};d.async=function(c){return function(){function b(c,h){var g;if(I){try{g=d[c](h)}catch(k){return u(k)}return g.done?g.value:t(g.value,e,f)}try{g=d[c](h)}catch(m){return"[object StopIteration]"===da(m)||m instanceof H?m.value:u(m)}return t(g,e,f)}var d=c.apply(this,arguments),e=b.bind(b,"next"),f=b.bind(b,"throw");return e()}};d.spawn=function(c){d.done(d.async(c)())};d["return"]=function(c){throw new H(c);};d.promised=function(c){return function(){return P([this,y(arguments)],function(b,d){return c.apply(b, d)})}};d.dispatch=R;g.prototype.dispatch=function(c,b){var d=this,e=p();return s(function(){d.promiseDispatch(e.resolve,c,b)}),e.promise};d.get=function(c,b){return d(c).dispatch("get",[b])};g.prototype.get=function(c){return this.dispatch("get",[c])};d.set=function(c,b,e){return d(c).dispatch("set",[b,e])};g.prototype.set=function(c,b){return this.dispatch("set",[c,b])};d.del=d["delete"]=function(c,b){return d(c).dispatch("delete",[b])};g.prototype.del=g.prototype["delete"]=function(c){return this.dispatch("delete", [c])};d.mapply=d.post=function(c,b,e){return d(c).dispatch("post",[b,e])};g.prototype.mapply=g.prototype.post=function(c,b){return this.dispatch("post",[c,b])};d.send=d.mcall=d.invoke=function(c,b){return d(c).dispatch("post",[b,q(arguments,2)])};g.prototype.send=g.prototype.mcall=g.prototype.invoke=function(c){return this.dispatch("post",[c,q(arguments,1)])};d.fapply=function(c,b){return d(c).dispatch("apply",[void 0,b])};g.prototype.fapply=function(c){return this.dispatch("apply",[void 0,c])};d["try"]= d.fcall=function(c){return d(c).dispatch("apply",[void 0,q(arguments,1)])};g.prototype.fcall=function(){return this.dispatch("apply",[void 0,q(arguments)])};d.fbind=function(c){var b=d(c),e=q(arguments,1);return function(){return b.dispatch("apply",[this,e.concat(q(arguments))])}};g.prototype.fbind=function(){var c=this,b=q(arguments);return function(){return c.dispatch("apply",[this,b.concat(q(arguments))])}};d.keys=function(c){return d(c).dispatch("keys",[])};g.prototype.keys=function(){return this.dispatch("keys", [])};d.all=y;g.prototype.all=function(){return y(this)};d.allResolved=l(S,"allResolved","allSettled");g.prototype.allResolved=function(){return S(this)};d.allSettled=U;g.prototype.allSettled=function(){return U(this)};d.fail=d["catch"]=function(c,b){return d(c).then(void 0,b)};g.prototype.fail=g.prototype["catch"]=function(c){return this.then(void 0,c)};d.progress=function(c,b){return d(c).then(void 0,void 0,b)};g.prototype.progress=function(c){return this.then(void 0,void 0,c)};d.fin=d["finally"]= function(c,b){return d(c)["finally"](b)};g.prototype.fin=g.prototype["finally"]=function(c){return c=d(c),this.then(function(b){return c.fcall().then(function(){return b})},function(b){return c.fcall().then(function(){throw b;})})};d.done=function(c,b,e,f){return d(c).done(b,e,f)};g.prototype.done=function(b,e,f){var g=function(b){s(function(){if(m(b,k),!d.onerror)throw b;d.onerror(b)})},k=b||e||f?this.then(b,e,f):this;"object"==typeof process&&process&&process.domain&&(g=process.domain.bind(g)); k.then(void 0,g)};d.timeout=function(b,e,f){return d(b).timeout(e,f)};g.prototype.timeout=function(b,d){var e=p(),f=setTimeout(function(){e.reject(Error(d||"Timed out after "+b+" ms"))},b);return this.then(function(b){clearTimeout(f);e.resolve(b)},function(b){clearTimeout(f);e.reject(b)},e.notify),e.promise};d.delay=function(b,e){return void 0===e&&(e=b,b=void 0),d(b).delay(e)};g.prototype.delay=function(b){return this.then(function(d){var e=p();return setTimeout(function(){e.resolve(d)},b),e.promise})}; d.nfapply=function(b,e){return d(b).nfapply(e)};g.prototype.nfapply=function(b){var d=p();b=q(b);return b.push(d.makeNodeResolver()),this.fapply(b).fail(d.reject),d.promise};d.nfcall=function(b){var e=q(arguments,1);return d(b).nfapply(e)};g.prototype.nfcall=function(){var b=q(arguments),d=p();return b.push(d.makeNodeResolver()),this.fapply(b).fail(d.reject),d.promise};d.nfbind=d.denodeify=function(b){var e=q(arguments,1);return function(){var f=e.concat(q(arguments)),g=p();return f.push(g.makeNodeResolver()), d(b).fapply(f).fail(g.reject),g.promise}};g.prototype.nfbind=g.prototype.denodeify=function(){var b=q(arguments);return b.unshift(this),d.denodeify.apply(void 0,b)};d.nbind=function(b,e){var f=q(arguments,2);return function(){var g=f.concat(q(arguments)),k=p();return g.push(k.makeNodeResolver()),d(function(){return b.apply(e,arguments)}).fapply(g).fail(k.reject),k.promise}};g.prototype.nbind=function(){var b=q(arguments,0);return b.unshift(this),d.nbind.apply(void 0,b)};d.nmapply=d.npost=function(b, e,f){return d(b).npost(e,f)};g.prototype.nmapply=g.prototype.npost=function(b,d){var e=q(d||[]),f=p();return e.push(f.makeNodeResolver()),this.dispatch("post",[b,e]).fail(f.reject),f.promise};d.nsend=d.nmcall=d.ninvoke=function(b,e){var f=q(arguments,2),g=p();return f.push(g.makeNodeResolver()),d(b).dispatch("post",[e,f]).fail(g.reject),g.promise};g.prototype.nsend=g.prototype.nmcall=g.prototype.ninvoke=function(b){var d=q(arguments,1),e=p();return d.push(e.makeNodeResolver()),this.dispatch("post", [b,d]).fail(e.reject),e.promise};d.nodeify=function(b,e){return d(b).nodeify(e)};g.prototype.nodeify=function(b){return b?(this.then(function(d){s(function(){b(null,d)})},function(d){s(function(){b(d)})}),void 0):this};e.exports=d;var X=n()},{}]},{},[1]); if("undefined"==typeof winusbDevice){var winusbDevice=function(b){this.device=b};winusbDevice.prototype.open=function(){var b=winusbDevice.addCallback(),e=this;window.postMessage({destination:"PUP_EXT",command:"OPEN",id:b,parameters:{device:this.device}},"*");return winusbDevice.callbacks[b].promise.then(function(b){e.id=b.deviceId})};winusbDevice.prototype.send=function(b){var e=winusbDevice.addCallback();window.postMessage({destination:"PUP_EXT",command:"SEND",id:e,parameters:{deviceId:this.id, data:b}},"*");return winusbDevice.callbacks[e].promise};winusbDevice.prototype.recv=function(b){var e=winusbDevice.addCallback();window.postMessage({destination:"PUP_EXT",command:"RECV",id:e,parameters:{deviceId:this.id,size:b}},"*");return winusbDevice.callbacks[e].promise};winusbDevice.prototype.close=function(){var b=winusbDevice.addCallback();window.postMessage({destination:"PUP_EXT",command:"CLOSE",id:b,parameters:{deviceId:this.id}},"*");return winusbDevice.callbacks[b].promise};winusbDevice.addCallback= function(){var b=Q.defer(),e=winusbDevice.id++;winusbDevice.callbacks[e]=b;return e};winusbDevice.enumerateDongles=function(){var b=winusbDevice.addCallback();window.postMessage({destination:"PUP_EXT",command:"ENUMERATE",id:b,parameters:{vid:9601,pid:6152}},"*");return winusbDevice.callbacks[b].promise};winusbDevice.callbacks={};winusbDevice.id=0;window.addEventListener("message",function(b){if("PUP_APP"==b.data.destination){var e=winusbDevice.callbacks[b.data.id];delete winusbDevice.callbacks[b.data.id]; "undefined"!=typeof b.data.response.exception?e.reject(b.data.response.exception):e.resolve(b.data.response)}},!1)} var ASCII=1,HEX=5,ByteString=Class.create({initialize:function(b,e){this.encoding=e;switch(e){case HEX:this.value=Convert.hexToBin(b);break;case ASCII:this.value=b;break;default:throw"Invalid arguments";}this.length=this.value.length},byteAt:function(b){if(1>arguments.length)throw"Argument missing";if("number"!=typeof b)throw"Invalid index";if(0>b||b>=this.value.length)throw"Invalid index offset";return Convert.readHexDigit(Convert.stringToHex(this.value.substring(b,b+1)))},bytes:function(b,e){var f; if(1>arguments.length)throw"Argument missing";if("number"!=typeof b)throw"Invalid offset";if(0>b)throw"Invalid offset";if("number"==typeof e){if(0>e)throw"Invalid count";f=new ByteString(this.value.substring(b,b+e),ASCII)}else if("undefined"==typeof e)f=new ByteString(this.value.substring(b),ASCII);else throw"Invalid count";f.encoding=this.encoding;return f},concat:function(b){if(1>arguments.length)throw"Not enough arguments";if(!(b instanceof ByteString))throw"Invalid argument";var e=new ByteString(this.value+ b.value,ASCII);e.encoding=this.encoding;return e},equals:function(b){if(1>arguments.length)throw"Not enough arguments";if(!(b instanceof ByteString))throw"Invalid argument";return this.value==b.value},toString:function(b){var e=this.encoding;if(1<=arguments.length){if("number"!=typeof b)throw"Invalid encoding";switch(b){case HEX:case ASCII:break;default:throw"Unsupported arguments";}e=b}switch(e){case HEX:return Convert.stringToHex(this.value);case ASCII:return this.value;default:throw"Unsupported"; }},toStringIE:function(b){var e=this.encoding;if(1<=arguments.length){if("number"!=typeof b)throw"Invalid encoding";switch(b){case HEX:case ASCII:break;default:throw"Unsupported";}e=b}switch(e){case HEX:return Convert.stringToHex(this.value);case ASCII:return this.value;default:throw"Unsupported";}}});ByteString.XOR=1;var Convert=Class.singleton({initialize:function(){throw"Abstract class";}}); Convert.stringToHex=function(b){for(var e="",f="0123456789abcdef".split(""),m=0;m<b.length;m++)e+=f[b.charCodeAt(m)>>4]+f[b.charCodeAt(m)&15];return e};Convert.hexToBin=function(b){var e="";if(0!=b.length%2)throw"Invalid string";b=b.toUpperCase();for(var f=0;f<b.length;f+=2){var m="0123456789ABCDEF".indexOf(b.charAt(f));if(0>m)return"";var k="0123456789ABCDEF".indexOf(b.charAt(f+1));if(0>k)return"";e+=String.fromCharCode((m<<4)+k)}return e}; Convert.readHexDigit=function(b,e){"undefined"==typeof e&&(e=0);return("0123456789ABCDEF".indexOf(b.substring(e,e+1).toUpperCase())<<4)+"0123456789ABCDEF".indexOf(b.substring(e+1,e+2).toUpperCase())};Convert.toHexDigit=function(b){return"0123456789abcdef".charAt(b>>4)+"0123456789abcdef".charAt(b&15)};Convert.toHexByte=function(b){return Convert.toHexDigit(b)};Convert.toHexByteBCD=function(b){return Convert.toHexDigit(b/10*16+b%10)}; Convert.toHexShort=function(b){return Convert.toHexDigit(b>>8&255)+Convert.toHexDigit(b&255)};Convert.toHexInt=function(b){return Convert.toHexDigit(b>>24&255)+Convert.toHexDigit(b>>16&255)+Convert.toHexDigit(b>>8&255)+Convert.toHexDigit(b&255)}; var Card=Class.create({initialize:function(){throw"abstract class";},getTerminal:function(){},getAtr:function(){},exchange:function(b,e){},exchangeMultiple:function(b,e,f,m){if(!(b instanceof Array))throw"Invalid apdus";if(!(e instanceof Array))throw"Invalid statuses";if(b.length!=e.length)throw"APDUs and status length differ";"undefined"==typeof f&&(f=!1);"undefined"==typeof m&&(m=!0);var k,n;f&&(n=[]);for(var l=0;l<b.length;l++){var d;if(b[l]instanceof ByteString)k=b[l],d=void 0;else if(b[l]instanceof Array){if(!(b[l][0]instanceof ByteString))throw"APDU array "+l+" content must be a ByteString";if("number"!=typeof b[l][1])throw"APDU array "+l+" returned length must be a Number";k=b[l][0];d=b[l][1]}else throw"APDU "+l+" must be a ByteString";if(!(e[l]instanceof Array))throw"status "+l+" must be an Array";k=this.exchange(k,d);for(d=0;d<e[l].length;d++)if("number"==typeof e[l][d]){if(this.SW==e[l][d])break}else if((this.SW&e[l][d][1])==e[l][d][0])break;if(d==e[l].length&&m)throw"Status "+l+" differ - "+ Convert.toHexShort(this.SW);if(f&&(n.push(k.concat(new ByteString(""+Convert.toHexShort(this.SW),HEX))),d==e[l].length))break}return f?n:k},sendApdu:function(b,e,f,m,k,n,l,d){var p,r;if(b instanceof ByteString)e instanceof Array&&(p=e);else{if("number"!=typeof b)throw"Invalid CLA";if("number"!=typeof e)throw"Invalid INS";if("number"!=typeof f)throw"Invalid P1";if("number"!=typeof m)throw"Invalid P2";e=Convert.toHexDigit(b)+Convert.toHexDigit(e)+Convert.toHexDigit(f)+Convert.toHexDigit(m);"number"== typeof k?(e+=Convert.toHexDigit(k),r=k):e=k instanceof ByteString?e+(Convert.toHexDigit(k.length)+k.toStringIE(HEX)):e+"00";b=new ByteString(e,HEX);if(k instanceof Array){if("undefined"!=typeof n||"undefined"!=typeof l)throw"Invalid parameters";p=k}else if(k instanceof ByteString){if("undefined"!=typeof n||"undefined"!=typeof l)if(n instanceof Array&&"undefined"==typeof l)p=n;else if("number"==typeof r&&op3 instanceof Array)r=n,p=l;else throw"Invalid parameters";}else if("number"==typeof k){if("undefined"!= typeof n||"undefined"!=typeof l)if(n instanceof Array&&"undefined"==typeof l)p=n;else throw"Invalid parameters";}else if("undefined"==typeof k&&("undefined"!=typeof n||"undefined"!=typeof l))throw"Invalid parameters";}if(p){if(1>p.length)throw"Invalid SW check";for(k=0;k<p.length;k++)if(p[k]instanceof Array){if(2!=p[k].length||"number"!=typeof p[k][0]||"number"!=typeof p[k][1])throw"Invalid SW parameter "+(k+1);}else if("number"!=typeof p[k])throw"Invalid SW parameter "+(k+1);}this._preExchange(b, p,d);var g=this;return("undefined"==typeof d?this.exchange(b,r):d.exchangeWrapped(b,r)).then(function(b){g.response=b;if(p){for(var d=0;d<p.length;d++)if("number"==typeof p[d]){if(g.SW==p[d])break}else if((g.SW&p[d][1])==p[d][0])break;if(d==p.length)throw"Invalid status "+d+" - "+Convert.toHexShort(g.SW);}return b})},_preExchange:function(b,e,f){},getSW:function(){},getSW1:function(){},getSW2:function(){},beginExclusive:function(){},endExclusive:function(){},openLogicalChannel:function(b){},reset:function(b){}, disconnect:function(b){}});Card.RESET_WARM=1;Card.RESET_COLD=2;Card.LEAVE=3; var ChromeapiPlugupCardTerminal=Class.create({initialize:function(b,e){this.device=b;this.terminalName=e},isCardPresent:function(){return!0},getCard:function(){if("undefined"==typeof this.cardInstance)return this.cardInstance=new ChromeapiPlugupCard(this,this.device),this.cardInstance.connect();var b=this;return Q.fcall(function(){return b.cardInstance})},getTerminalName:function(){return this.terminalName},getName:function(){return"undefined"==typeof this.terminalName||0==this.terminalName.length? "Default":this.terminalName}}),ChromeapiPlugupCardTerminalFactory=Class.create({initialize:function(){},list:function(){if("undefined"==typeof winusbDevice)throw"Content script is not available";return winusbDevice.enumerateDongles().then(function(b){return b.deviceList})},waitInserted:function(){throw"Not implemented";},getCardTerminal:function(b){return new ChromeapiPlugupCardTerminal(b)}}),ChromeapiPlugupCard=Class.extend(Card,{initialize:function(b,e){this.device=new winusbDevice(e);this.terminal= b},connect:function(){var b=this;return this.device.open().then(function(e){b.connection=!0;return b})},getTerminal:function(){return this.terminal},getAtr:function(){return new ByteString("",HEX)},beginExclusive:function(){},endExclusive:function(){},openLogicalChannel:function(b){throw"Not supported";},exchange:function(b,e){var f=this;if(!(b instanceof ByteString))throw"Invalid parameter";if(!this.connection)throw"Connection is not open";return f.device.send(b.toString(HEX)).then(function(b){return f.device.recv(512)}).then(function(e){e= new ByteString(e.data,HEX);var k;if(97!=e.byteAt(0))f.SW1=e.byteAt(0),f.SW2=e.byteAt(1),k=new ByteString("",HEX);else{var n=e.byteAt(1);k=e.bytes(2,n);f.SW1=e.byteAt(2+n);f.SW2=e.byteAt(2+n+1)}f.SW=(f.SW1<<8)+f.SW2;"undefined"!=typeof f.logger&&f.logger.log(f.terminal.getName(),0,b,k,f.SW);return k})},reset:function(b){},disconnect:function(b){var e=this;if(this.connection)return this.device.close().then(function(b){e.connection=!1})},getSW:function(){return this.SW},getSW1:function(){return this.SW1}, getSW2:function(){return this.SW2},setCommandDelay:function(b){},setReportDelay:function(b){},getCommandDelay:function(){return 0},getReportDelay:function(){return 0}});
